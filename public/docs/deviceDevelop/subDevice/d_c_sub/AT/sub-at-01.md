# __AT指令概览__

| 指令名称| 功能描述    |
|:--------:| :-------------:|
| [AT+QIOTSUBCONN](#AT+QIOTSUBCONN) | 连接子设备至网关 |
|  [AT+QIOTSUBDISCONN](#AT+QIOTSUBDISCONN)| 断开/注销子设备与网关的连接 |
|  [AT+QIOTSUBSEND](#AT+QIOTSUBSEND) | 发送子设备透传数据至平台 |
|  [AT+QIOTSUBRD](#AT+QIOTSUBRD)| 子设备读取平台下发的透传数据 |
|  [AT+QIOTSUBTSLTD](#AT+QIOTSUBTSLTD)| 发送子设备物模型数据至平台 |
|   [AT+QIOTSUBTSLRD](#AT+QIOTSUBTSLRD)| 读取平台下发的物模型数据 |
| [AT+QIOTSUBHTB](#AT+QIOTSUBHTB) | 发送心跳包 |

## **相关AT指令详情**

<span id="AT+QIOTSUBCONN">  </span>
## <font color=#A52A2A  >__AT+QIOTSUBCONN (连接子设备至网关)__</font>

* __说明__：该命令用于将子设备连接到网关。
* __最大响应时间__ ：300 毫秒。


### 测试命令

__发送：__

```c
AT+QIOTSUBCONN=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBCONN: <sessionType>,<lifetime>,<subPK>,<sub PS>,<subDK>[,<subDS>]
	
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBCONN=<sessionType>,<lifetime>,<subPK>,<subPS>,<subDK>[,<subDS>]
```	
__响应：__

* 设置成功

	```c
	OK
	```
	
* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__

 * __`<sessionType>`__：整型。子设备交互数据加密方式。
 * __`<lifetime>`__： 整型。子设备保活时间。范围：60~65534；单位：秒。
 * __`<subPK>`__ ：字符串类型。在开发者中心创建产品时生成的 ProductKey。
 * __`<subPS>`__：字符串类型。在开发者中心创建产品时生成的 ProductSecret。
 * __`<subDK>`__ ：字符串类型。子设备唯一标识。
 * __`<subDS>`__：字符串类型。认证到平台时，平台下发的设备秘钥。

__备注：__

2.9.0及以上版本支持。

#### 示例
__示例一(子设备连接网关)__
```c
[TX]AT+QIOTSUBCONN=0,60,"p1126m","RGtwxxxxxxxxSUls","123456"

[RX]OK
```
***


<span id="AT+QIOTSUBDISCONN">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBDISCONN (断开/注销子设备与网关的连接)__</font>

* __说明__：该命令用于断开/注销子设备与网关之间的连接。
* __最大响应时间__ ：300 毫秒。

### 测试命令

__发送：__

```c
AT+QIOTSUBDISCONN=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBDISCONN: <subPK>,<subDK>[,<subPS>,<subDS>]
	
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBDISCONN=<subPK>,<subDK>[,<subPS>,<subDS>]
```	
__响应：__

* 设置成功

	```c
	OK
	```
	
* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__
 * __`<subDK>`__ ：字符串类型，子设备唯一标识。
 * __`<subPK>`__ ：字符串类型，在平台创建产品时生成的 ProductKey。
 * __`<subDS>`__：字符串类型，认证到平台时，平台下发的设备秘钥。
 * __`<subPS>`__：字符串类型，在平台创建产品时生成的 ProductSecret。


__备注：__

2.9.2及以上版本支持。
#### 示例
__示例一(子设备断开网关)__
```c
[TX]AT+QIOTSUBDISCONN="p1126m","123456"

[RX]OK
```

__示例二(子设备注销网关)__
```c
[TX]AT+QIOTSUBDISCONN="p1126m","RGtwxxxxxxxxSUls","123456","1213xxxxxxxx345"

[RX]OK
```
<font color=#999AAA >提示：子设备注销网关后，旧subDS不可再用，需要重新认证返回新subDS。</font>
***

<span id="AT+QIOTSUBSEND">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBSEND (发送子设备透传数据至平台)__</font>

* __说明__：该命令用于将子设备的透传数据发送至平台。
* __最大响应时间__ ：300 毫秒。
* __特性说明__： 该命令立即生效。


### 测试命令

__发送：__

```c
AT+QIOTSUBSEND=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBSEND: <subPK>,<subDK>,(支持的<length>范围),<data>
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBSEND=<subPK>,<subDK>,<length>[,<data>]
```	
__响应：__

* 若省略可选参数且子设备连接已经建立
	```c	
	>
	```
	响应>后，输入长度等于\<length>的数据。
	
	* 若已配置需回复上行消息 __PkgID__ 
		```c	
		+QIOTSUBSEND:<subPK>,<subDK>,<txid>
	
		OK
		```
	* 否则
		```c	
		OK
		```

* 若指定可选参数且子设备连接已经建立
	* 若已配置需回复上行消息 __PkgID__ 
		```c
		+QIOTSUBSEND:<subPK>,<subDK>,<txid>
	
		OK
		```	
	* 否则返回内容为
		```c
		OK
		```	
* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__

 * __`<subPK>`__ ：字符串类型。在平台创建产品时生成的 ProductKey。
 * __`<subDK>`__ ：字符串。子设备唯一标识。
 * __`<length>`__ ：整型。待发送数据长度。单位：字节。
 	*	 若设置命令中指定\<data\>，长度范围以测试命令实际返回值为准。
 	*	若设置命令中不指定\<data\>，长度范围以模块性能为准。
 * __`<data>`__ ：发送数据。
	 * 若设置命令中指定\<data\>，待发送数据仅可为字符串类型。
	 * 若设置命令中不指定\<data\>，待发送数据为任意字节流类型，以模块性能为准。
 * __`<txid>`__ ：整型。范围：1~65535。
 
__备注：__

2.9.0及以上版本支持。

#### __示例__
__示例一(子设备发送透传数据)__
子设备发送"123456ABC"的透传数据到云平台
```c
[TX]AT+QIOTSUBSEND="p1126m","123456",9,"123456ABC"

[RX]OK

[RX]+QIOTSUBEVT: "p1126m","123456",4,10200
```

***


<span id="AT+QIOTSUBRD">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBRD (读取平台下发的透传数据)__</font>

* __说明__：该命令用于读取平台下发至子设备的透传数据。
* __最大响应时间__ ：300 毫秒。
* __特性说明__： 该命令立即生效；参数配置自动保存。




### 测试命令

__发送：__

```c
AT+QIOTSUBRD=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBRD: <subPK>,<subDK>,(支持的<req_length>范围)
	
	OK
	```
### 查询命令

__发送：__

```c
AT+QIOTSUBRD?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBRD: <subPK>,<subDK>,<remain_pieces> 
	+QIOTSUBRD: <subPK>,<subDK>,<remain_pieces> 
	...
	
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBRD=<subPK>,<subDK> [,<req_length>]
```	
__响应：__

* 若省略参数 req_length，则表示查询当前子设备缓存透传长度

	```c
	+QIOTSUBRD: <subPK>,<subDK>,<remain_pieces>
	
	OK
	```
* 若携带参数 req_length，则表示读取当前子设备缓存数据

	```c
	+QIOTSUBRD: <subPK>,<subDK>,<cur_len>,<remain_len>,< remain_pieces><CR><LF>
	<data>
	
	OK
	```
	
* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__

 * __`<subDK>`__ ：字符串类型。子设备唯一标识。
 * __`<subPK>`__ ：字符串类型。在开发者中心创建产品时生成的 ProductKey。
 * __`<req_length>`__ ：整型。读取的数据长度。长度范围以测试命令实际返回值为准。
 * __`<cur_len>`__ ：整型。实际读取的数据长度。
 * __`<data>`__ ：字节流类型。读取的数据。
 * __`<remain_len>`__ ：整型。当前数据包剩余未读的数据长度。单位：字节。
 * __`<remain_pieces>`__ ：整型。剩余数据包个数。



__备注：__

2.9.0及以上版本支持。
#### 示例
__示例一(缓存模式下子设备读取透传数据)__

i.开发者中心下发透传数据  

ii.子设备接收到透传数据向串口打印回调事件

```c
[RX]+QIOTSUBEVT: "p1126C","123456",5,10200
```
iii.MCU主动发送查询指令 __AT+QIOTSUBRD="p1126C","12345678",512__ 后，查询到透传数据为"123456ABC"
```c
[TX]AT+QIOTSUBRD="p1126C","123456",512

[RX]+QIOTSUBRD: "p1126C","123456",9,0,2
[RX]123456ABC

OK
```
__示例二(非缓存模式下子设备读取透传数据)__

i.开发者中心下发透传数据  

ii.子设备接收到透传数据向串口打印回调事件及透传数据

```c
[RX]+QIOTSUBEVT: "p1126C","123456",5,10200,9
123456ABC
```
***

<span id="AT+QIOTSUBTSLTD">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBTSLTD (发送子设备物模型数据至平台)__</font>

* __说明__：该命令用于发送子设备物模型数据至平台。设置命令中若指定\<PkgID\>，则发送数据为应答平台数据请求；若省略\<PkgID\>，则发送数据至平台，发送成功时，MCU接收事件+QIOTSUBEVT: \<subPK\>,\<subDK\>,4,10210，表示物模型数据发送成功。
* __最大响应时间__ ：300 毫秒。
* __特性说明__： 该命令立即生效；



### 测试命令

__发送：__

```c
AT+QIOTSUBTSLTD=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBTSLTD:<subPK>,<subDK>,<length>,(支持的 <PkgID> 范围)
	
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBTSLTD=<subPK>,<subDK>,<length>[,<PkgID>]
```	
__响应：__

```c
>
```
响应>后，输入长度等于\<length\>的字节流数据。

* 若指定可选参数\<PkgID>，则为应答平台查询的消息
	```c
	OK
	```
* 若省略可选参数\<PkgID>，则为主动发送上行消息
	* 若已配置需回复上行消息 __PkgID__ 
		```c
		+QIOTSUBTSLTD:<subPK>,<subDK>,<txid>
		
		OK
		```
	* 否则返回内容为
	
		```c
		OK	
		```
	
* 若出现任何错误
	```c
	ERROR
	```	


__参数：__

 * __`<subPK>`__ ：字符串类型。在平台创建产品时生成的 ProductKey。
 * __`<subDK>`__ ：字符串类型。子设备唯一标识。
 * __`<length>`__ ：整型。待发送数据长度。长度范围以具体模块性能为准。
 * __`<PkgID>`__ ：整型。请求包 ID。范围：1~65534。仅当设备需响应平台数据请求时需指定该参数。
 * __`<txid>`__ ：整型。上行消息 ID。范围：1~65535。


__备注：__

2.9.0及以上版本支持。
#### 示例

__示例一(发送物模型数据)__

需发送的物模型数据如下所示。
ID ：1；数据类型：Bool；数值：	true。ID：2；数据类型：int	；数值：30。

```c
[TX]AT+QIOTSUBTSLTD="p1126m","123456",17
[RX]> 
[TX]{"1":true,"2":30}
[RX]OK

[RX]+QIOTSUBEVT: "p1126m","123456",4,10210
```
***


<span id="AT+QIOTSUBTSLRD">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBTSLRD (读取平台下发的物模型数据)__</font>

* __说明__：该命令用于读取子设备接收的由开发者中心下发的物模型数据。
* __最大响应时间__ ：300 毫秒。
* __特性说明__： 该命令立即生效。



### 测试命令

__发送：__

```c
AT+QIOTSUBTSLRD=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBTSLRD:<subPK>,<subDK>,(支持的 <req_length> 范围)
	
	OK
	```
### 查询命令

__发送：__

```c
AT+QIOTSUBTSLRD?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBTSLRD:<subPK>,<subDK>,<remain_pieces> 
	+QIOTSUBTSLRD:<subPK>,<subDK>,<remain_pieces>
	...
	
	OK
	```
### 设置命令

__发送：__

```c
AT+QIOTSUBTSLRD=<subPK>,<subD K>[,<req_length>]
```	
__响应：__

* 若省略可选参数，则查询当前子设备缓存的物模型数据长度

	```c
	+QIOTSUBTSLRD: <subPK>,<subDK>,<remain_pieces>
	
	OK
	```
* 若指定可选参数，则读取当前子设备缓存的物模型数据

	```c
	+QIOTSUBTSLRD: <subPK>,<subDK>,<cur_len>,<remain_l en>,<remain_pieces><CR><LF>
	<data>
	
	OK
	```
	
* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__

 * __`<subDK>`__ ：字符串类型。子设备唯一标识。
 * __`<subPK>`__ ：字符串类型。在平台创建产品时生成的 ProductKey。
 * __`<req_length>`__ ：整型。读取的数据长度。长度范围以测试命令实际返回值为准。
 * __`<cur_len>`__ ：整型。实际读取的数据长度。
 * __`<data>`__ ：字节流类型。读取的物模型数据。
 * __`<remain_len>`__ ：整型。当前数据包剩余未读的数据长度。单位：字节。
 * __`<remain_pieces>`__ ：整型。剩余数据包个数。

__备注：__

2.9.0及以上版本支持。
#### 示例
__示例一(缓存模式下子设备读取物模型)__

i.开发者中心下发物模型数据  

ii.模组收到下发指令并向MCU打印回调事件与数据

```c
[RX]+QIOTSUBEVT: "p1126C","123456",5,10200
```
iii.模组收到物模型数据后，会主动向MCU打印回调事件 +QIOTSUBEVT: “p1126m”,“123123123”,5,10210,10 与下发的物模型数据 {“1”:true}。
```c
[TX]AT+QIOTSUBTSLRD="p1126m","123456",512

[RX]+QIOTSUBEVT: "p1126m","123456",5,10210,10
{"1":true}

[RX]OK
```
__示例二(非缓存模式下子设备主动打印物模型数据)__

i.开发者中心下发物模型数据

ii.子设备接收到物模型数据后会主动向串口打印回调事件及数据

```c
[RX]+QIOTSUBEVT: "p1126m","123456",5,10210,10
[RX]{"1":true}
```

***


<span id="AT+QIOTSUBHTB">  </span>

## <font color=#A52A2A  >__AT+QIOTSUBHTB (子设备心跳包)__</font>

* __说明__：该命令用于发送心跳包以刷新子设备与网关最后交互的时间。
* __最大响应时间__ ：300 毫秒。
* __特性说明__： 该命令立即生效。




### 测试命令

__发送：__

```c
AT+QIOTSUBHTB=?
```	
__响应：__

* 响应支持的可设置参数范围

	```c
	+QIOTSUBHTB:<subPK>,<subDK>
	
	OK
	```
	
### __设置命令__

__发送：__

```c
AT+QIOTSUBHTB=<subPK>,<subDK>
```	
__响应：__



* 设置成功

	```c
	OK
	```

* 若出现任何错误
	```c
	ERROR
	```	
***


__参数：__

 * __`<subPK>`__ ：字符串类型。在平台创建产品时生成的 ProductKey。
 * __`<subDK>`__ ：字符串类型。子设备唯一标识。


__备注：__

2.9.0及以上版本支持。
#### __示例__

__示例一(子设备发送心跳包)__

```c
[TX]AT+QIOTSUBHTB="p1126m","12345678"

[RX]OK
```


## __子设备接入开发者中心相关事件__
##  __事件回调格式：__

> +QIOTSUBEVT: \<subPK\>,\<subDK\>,\<event_type\>,\<event_code\>,[,\<data\>]]

##  __事件类别解析：__

 * __`<event_type>`__ ：整型。事件标识符。
 	*	__`1`__：认证操作
 	*	__`2`__：登录操作 
 	*	__`4`__：发送数据操作
 	*	__`5`__：接收数据操作
 	*	__`6`__：登出平台操作
 	*	__`8`__：平台事件
 	*	__`10`__：注销平台操作
* __`<event_code>`__： 整型。事件返回码。
* __`<data>`__： 事件携带数据内容。

##  __事件返回码<event_type><event_code>：__

## __1：认证操作__

| 事件标识,事件码 | 描述    |
|:--------:| :-------------:|
|1,10200	|URC中紧跟,\<subDS>，设备认证成功|
|1,10404	|平台内部接口调用错误|
|1,10422	|设备已认证（连接失败）|
|1,10423	|查询产品信息失败（连接失败）|
|1,10425	|签名验证未通过（连接失败）|
|1,10427	|散列信息不合法（连接失败）|
|1,10431	|DK不合法（连接失败）|
|1,10500	|设备认证失败（系统发生未知异常）|
|1,10440	|网关与子设备无关联关系|


## __2：登录操作__

| 事件标识,事件码 | 描述    |
|:--------:| :-------------:|
|2,10200	|登录成功|
|2,10404	|平台内部接口调用错误|
|2,10430	|设备密钥不正确（连接失败）|
|2,10431	|设备被禁用（连接失败）|
|2,10433	|Flag不合法|
|2,10434	|ClientID与password不匹配（password中包涵ClientID相关信息）|
|2,10437	|子设备DS错误|
|2,10438	|没查到设备信息|
|2,10500	|注册失败（系统发生未知异常）|
|2,10440	|网关与子设备无关联关系|
|2,10441	|子设备已连接（连接成功）|

## __4：发送数据操作__

| 事件标识,事件码 | 描述    |备注|
|:--------:| :-------------:| :-------------:|
|4,10200	|[,\<txid>]子设备透传数据发送成功|txid_mode配置项开启后返回txid|
|4,10210	|[,\<txid>]子设备物模型数据发送成功|txid_mode配置项开启后返回txid|
|4,10300	|[,\<txid>]透传数据发送失败|txid_mode配置项开启后返回txid|
|4,10310	|[,\<txid>]物模型数据发送失败|txid_mode配置项开启后返回txid|

##   __5：接收数据操作__

| 事件标识,事件码 | 描述    |备注|
|:--------:| :-------------:|:-------------:|
|5,10200	|URC中紧跟[,\<length>\<\r\n>\<data>]表示收到下发的透传数据。|下行数据为非缓存模式时，收到数据将直接下发|
|5,10210	|URC中紧跟[,\<length>\<\r\n>\<data>]表示收到下发的物模型数据。|下行数据为非缓存模式时，收到数据将直接下发|
|5,10211	|URC中紧跟,\<PkgID>,\<ID1>[,\<ID2>...]表示收到物模型查询命令。<br/>\<PkgID>		平台下发的请求包ID；<br/>\<ID>		物模型ID；|
|5,10473	|收到数据但长度超过模块缓存限制，接收失败|
|5,10428	|设备接收缓存过多导致限流|


## __6：登出操作__

| 事件标识,事件码 | 描述    |
|:--------:| :-------------:|
|6,10200	|登出成功|

##  __8：平台事件__

| 事件标识,事件码 | 描述    |
|:--------:| :-------------:|
|8,10428	|设备高频消息导致限流|
|8,10429	|超过单设备激活数量或者每日请求数导致限流|
|8,10442	|子设备没有登录|


## __10：注销操作__

| 事件标识,事件码 | 描述    |
|:--------:| :-------------:|
|10,10200	|注销成功| 
