# BLE通讯协议文档

此文档为指导app如何接入quecthing For Ble。


## __通信参数__

● 通信采用服务 UUID：0x180A<br />
● 二进制协议通信特征值 UUID：0x9C40 （app端采用write requst发送，设备端采用indicate发送）<br />
● 日志传输特征值 UUID：0x9C41 （设备端采用nofication发送）


## __数据包格式__

协议数据为二进制数据包格式，协议组成部分：
   
| 字段名               | 长度 | 内容                                                                      |
| :------------------- | :--- | :------------------------------------------------------------------------ |
| 协议头/版本号（Ver） | 2B   | 固定为0xAAAA                                                              |
| 数据域长度（Len）    | 2B   | 校验和到数据域的字节数（5-65535），该长度为数据真实长度，即数据转换前长度 |
| 校验和（Sum）        | 1B   | 对包Id到数据域的字节求和，高位溢出                                        |
| 包Id（Packet Id）    | 2B   | 0x0000和0xFFFF保留作将来使用，如出现保留值则认为是非法包                  |
| 命令字（Cmd)         | 2B   | 0x0000和0xFFFF保留作将来使用，如出现保留值则认为是非法包                  |
| 数据域（Data)        | NB   | 由命令字决定，可以为空，如不为空，内容一般为下文的TTLV格式                |

#### __协议头/版本号__
 1. 为了避免数据内容出现协议头数据从而影响了接收方的判断，需要对除协议头外的数据内容做转换处理。处理方式为：对于发送方，遇到0xAAAA，转换成0xAA55AA；遇到0xAA55AA，转换成0xAA5555AA。对于接收方，遇到0xAA，抛弃其后面的55。（即，对于发送方，遇到到0xAAAA(头)或0xAA55就在其中间插入0x55；对于接收方，遇到0xAA，就删除后面的0x55）

 2. 校验和应先于以上的#1完成。

 3. 接收方遇到协议头样的数据就认为是新包的开始，协议头之前的非完整包数据作丢弃处理。

 4. 后续需要升级版本号的规则为：从最右边开始升，范围从A~F依次进位递增，即后面的新版号依次为0xAAAB, 0xAAAC, 0xAAAD, 0xAAAE, 0xAAAF, 0xAABA，0xAABB等。
### __包ID__

发送方各自维护和递增自己的包Id。但对于回复信息，包Id应为被回复请求的包Id(即对方发送的请求包Id)。

### __命令字划分__
| 范围            | 应用领域           |
| :-------------- | :----------------- |
| 0x0000          | 保留               |
| 0x0001 - 0x0FFF | quecthing与开发者中心通信 |
| 0x1000 - 0x6FFF | 保留               |
| 0x7000 - 0x7FFF | quecthing与APP通信 |
| 0x8000 - 0x8FFF | 客户项目使用       |
| 0x9000 - 0xFFFF | 保留               |

### __TTLV格式约定__
TTLV格式组成部分：
  
| 字段名            | 长度  | 内容                                                                    |
| :---------------- | :---- | :---------------------------------------------------------------------- |
| 数据标识（id）    | 13bit | 范围1-8191，在不同的命令（cmd）内唯一（如物模型，设备状态，模组信息等） |
| 数据类型（type）  | 3bit  | 范围0-7，详见下表                                                       |
| 数据长度（length) |       | 详见下表                                                                |
| 数据值（value）   |       | 详见下表                                                                |

| 数据类型   | 字节编码(二进制3bit) | 数据长度                                                                     | 数据值   |
| :--------- | :------------------- | :--------------------------------------------------------------------------- | :------- |
| 布尔-false | 000                  | 无                                                                           | 无       |
| 布尔-true  | 001                  | 无                                                                           | 无       |
| 枚举和数值 | 010                  | 标识位1bit(0为正 1为负) <br> 衰减10的N次方4bit <br>数据字节数3bit（数据域的字节数-1） |          |
| 二进制数据 | 011                  | 数据字节数2B                                                                 | 数据内容 |
| 结构体     | 100                  | 元素个数2B                                                                   |          |
| 保留字段   | 101-111              |                                                                              |          |

## __流程说明__
### __一、整体__
1.设备未绑定状态：设备需进行绑定。此时第一个进行认证绑定的app作为管理员，绑定后设备重启进入已绑定状态。<br />
2.设备已绑定状态：app接入需进行认证，加密业务通讯。

<a data-fancybox title="img" href="/deviceDevelop/ble/resource/platform-10.png">![img](/deviceDevelop/ble/resource/platform-10.png)</a>

#### __相关命令__

| 命令名             | 字节格式 | 类型           | 方向                   | 说明                                                                               | 安全保障                   |
| :----------------- | :------- | :------------- | :--------------------- | :--------------------------------------------------------------------------------- | :------------------------- |
| 账号认证           | 0x8011   | Write          | 手机—>设备             | 手机连接上BLE后,APP需要发送账号给BLE认证通过才允许业务功能通信。参数ids：1,3(可选) |                            |
| 账号认证-回复      | 0x801c   | Write Response | 设备—>手机（0x8011的回复）  | 参数id：3,6                                                                          | Packet Id 为 0x8011 的Pkg Id     |
| 账号查询           | 0x8012   | Read           | 手机—>设备             | 认证后才能操作，管理员有效                                                         |    认证后才能操作，管理员有效                        |
| 账号查询-回复      | 0x8013   | Read Response  | 设备—>手机（  0x8012的回复） | authkey列表                                                                        | Packet Id 为 0x8012 的Pkg Id     |
| 账号授权/销权      | 0x8014   | Write          | 手机—>设备             | 参数id：1,2                                                                        | 认证后才能操作，仅管理员操作有效 |
| 账号授权/销权-回复 | 0x801d   | Write Response | 设备—>手机（  0x8014的回复） | 参数id:5                                                                          | Packet Id 为 0x8014 的Pkg Id     |

#### __功能字段的定义__

| Name         | 类型   | Id（13bit） | 备注                                                                            |
| :----------- | :----- | :---------- | :------------------------------------------------------------------------------ |
| authkey      | 二进制 | 1           | 终端用户账号,16字节                                                             |
| auth_account | 布尔   | 2           | True:账号授权 FALSE:账号销权                                                    |
| pinCode      | 数值   | 3           | 100000-999999                                                                   |
| Random       | 二进制 | 4           | 16字节                                                                          |
| result       | 布尔   | 5           | True:成功<br>False:失败                                                         |
| pairMode     | 枚举   | 6           | 1: Numeric Comparison<br>2: Just Works <br>3: Passkey Entry <br> 4: Out of Band |

### __二、绑定__
1. 设备未绑定状态，BLE 配对设置为连接不需要输入PIN码(或默认PIN码)。
2. 开启特定的广播，内容：厂商字段中放设备MAC(6byte)+产品PK(6byte)。（设备非未绑定状态，广播包不再放PK，避免其他app绑定其他设备时被影响，app可以通过厂商字段中是否有产品PK，来过滤掉不是绑定过程的广播包）。
<font color=#999AAA >提示：广播包里放MAC是app需要通过MAC来进行连接操作，比如app换手机重新连接需要根据广播包内的MAC确认连接对象。安卓可以通过MAC字段获取MAC，但ios有隐私屏蔽，app则需要通过厂商自定字段获取MAC。</font>


3. app内选择设备进行配对连接。
4. app生成随机密钥AuthKey（16byte）与PIN（100000~999999）通过协议特征通道进行认证发送给设备。
5. 设备收到AuthKey与PIN进行保存。设备重置，配对连接设置为加密状态，设置PIN为从app获取的PIN，设备从此进入已绑定状态。

### __三、认证__
1. 第一次绑定认证：app端发送AuthKey、PK、PIN。<br />
   ● AuthKey:认证密钥。设备未绑定状态，收到第一个AuthKey，作为以后认证的密钥保存下来。第二次接入认证需要此AuthKey进行认证鉴权。<br />
   ● PK：Product Key。供设备判断接入app是哪类产品。为空即超级app。<br />
   ● PIN：蓝牙配对密码。第一次进入认证需要带上此参数。之后的认证不需要。<br />
   ● 第一次认证获取的AuthKey，识别为管理员。

2. 收到app的认证指令后，设备返回Random、ifUsePin。<br />
   ● Random：随机码。16Byte，用作之后的通讯加密。<br />
   ● ifUsePin：sdk是否采用pin码。返回FALSE代表之后的配对链接都不使用PIN码。返回TRUE代表之后的配对链接使用认证时的PIN作为以后配对的PIN码。

### __四、分享（销授权）__
● 分享，指app通过授权指令，增加设备内的认证AuthKey，使得其他app用新AuthKey认证登入。（管理员有效）<br />
&emsp;&emsp;● 注意：管理员销权自身，设备重置回复初始化。
  
### __五、业务通讯__
● 认证过后，app获取到Random。之后的通讯都需要进行加密。<br />
● 业务通讯加密规则：aes128_cbc(PKCS5Padding(payload),key=!!MAC!!,iv=random)。

#### __1.透传__
##### __相关命令__

| 命令名       | 字节格式 | 类型  | 方向       | 说明                                    | 安全保障               |
| :----------- | :------- | :---- | :--------- | :-------------------------------------- | :--------------------- |
| 透传数据下发 | 0x0023   | Write | 手机—>设备 | -app下发透传消息 <br>-命令后为byte数据  | 由蓝牙indicate保障可靠 |
| 透传数据上发 | 0x0024   | Event | 设备—>手机 | -设备上报透传消息<br> -命令后为byte数据 | 由蓝牙indicate保障可靠 |

#### __2.物模型__
##### __相关命令__
| 命令名              | 字节格式 | 类型          | 方向                        | 说明                                                                                                                                                                | 安全保障                   |
| :------------------ | :------- | :------------ | :-------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------- |
| 物模型状态获取      | 0x0011   | Read          | APP端—>设备                 | -APP端获取设备指定物模型属性<br>-后面的数据域为空即为查询设备所有物模型数据<br>-后面的数据域不为空查询指定物模型数据，数据域格式为Byte数组，2个Byte代表一个物模型id |                            |
| 物模型状态上报-回复 | 0x0012   | Read Response | 设备—>APP端（0x0011的回复） | 设备收到云端获取物模型数据请求时的回复                                                                                                                              | Packet Id = 0x0011的Pkg Id |
| 物模型数据下发      | 0x0013   | Write         | APP端—>设备                 | -APP端调用设备，设置物模型属性 <br>-多个ttlv格式 <br>-异步回复，设备发生改变后，通过物模型上报命令上报                                                              |                            |
| 物模型数据上报      | 0x0014   | Event         | 设备—>APP端                 | -设备上报物模型数据，事件的触发，服务被调用后的回复                                                                                                                 |                            |

#### __3.OTA__
● 采用通用文件传输协议。

##### __通用文件传输协议__
<a data-fancybox title="img" href="/deviceDevelop/ble/resource/platform-11.png">![img](/deviceDevelop/ble/resource/platform-11.png)</a>

文件传输协议集
  
| 命令名            | 字节格式 | 类型            | 方向        | 必选参数ID | 可选参数ID           | 说明                                                                                                                                         |
| :---------------- | :------- | :-------------- | :---------- | :--------- | :------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- |
| 查询文件          | 0x7020   | Read            | 接方->发方  | 1、4       | 2、3                 |                                                                                                                                              |
| 查询文件-应答     | 0x7021   | Read Response   | 发方->接方  | 无         | 1、2、3、4、5、6，12 |                                                                                                                                              |
| 通知文件          | 0x7022   | Event           | 发方->接方  | 1、4、5、6 | 2、3、12             |                                                                                                                                              |
| 文件传输控制      | 0x7023   | Write           | 发方<->接方 | 7          | 8、11                | 1、在暂停(val=3)动作必须带上id：8(延时时长)告知对端等待超时<br>2、在接收(val=2)命令必须带上id：11(分包最大长度)告知发送方最大能发送的分包大小 |
| 文件传输控制-应答 | 0x7024   | Write Response | 发方<->接方 | 无         | 无                   |                                                                                                                                              |
| 发送文件分包      | 0x7025   | Write           | 发方->接方  | 9、10      | 无                   |                                                                                                                                              |
| 发送文件分包-应答 | 0x7026   | Write Response | 接方->发方  | 9          | 无                   |                                                                                                                                              |
功能字段定义
  
| 字段名       | 类型       | Id（13bit） | 备注                                                                                              |
| :----------- | :--------- | :---------- | :------------------------------------------------------------------------------------------------ |
| 文件类型     | 数值       | 1           |                                                                                                   |
| URL路径      | 二进制数据 | 2           | 接方->发方：文件下载路径<br>发方->接方：文件保存路径                                               |
| 文件名       | 二进制数据 | 3           |                                                                                                   |
| 检验方式     | 数值       | 4           | 取值<br> 0：MD5<br>1：CRC32<br>2：SHA256                                                             |
| 校验码       | 二进制数据 | 5           |                                                                                                   |
| 文件大小     | 数值       | 6           |                                                                                                   |
| 控制动作     | 数值       | 7           | 取值<br>1：拒绝<br>2：接收<br>3：暂停<br>4：继续<br>5：取消<br>6：接收完成且成功<br>7：接收完成且失败    |
| 延时时长     | 数值       | 8           | Unit: s ,此延时时长内不进行控制动作（继续、暂停等），超时触发对端发送 控制动作:取消，取消此次传输 |
| 起始地址     | 数值       | 9           |                                                                                                   |
| 包数据       | 二进制数据 | 10          |                                                                                                   |
| 分包最大长度 | 数值       | 11          |                                                                                                   |
| 版本号       | 二进制数据 | 12          |                                                                                                   |

##### __具体流程__
* OTA流程
    1. 通知文件命令(APP->设备),带以下参数：
        (1). 文件类型，作为识别升级类型（数值1：为fota固件）
        (2). 文件大小
        (3). 文件校验类型
        (4). 文件校验码
        (5). 版本号
    2. 文件传输控制命令（设备->APP）带以下参数：
        (1). 控制动作：接收/拒绝
        (2). 分包最大长度（选择接收时需要带上此参数）
    >* （可选）文件传输控制-应答命令（APP->设备）
    3. 发送文件分包（APP->设备）带以下参数：
       (1). 起始地址（即偏移）
       (2). 包数据
    4. 发送文件分包-应答（（设备->APP）
    >* (可选)文件传输控制命令（APP->设备）带以下参数：
       1. 控制动作：暂停
       2. 延时时间（暂停时需要告知设备暂停时间）
    >*  文件传输控制-应答命令（设备->APP）

    >* (可选)文件传输控制命令（APP->设备）带以下参数：
       1. 控制动作：继续
    >*  文件传输控制-应答命令（设备->APP）

    5. 文件传输控制命令（设备->APP）带以下参数：
        1. 控制动作：接收完成且成功/接收完成且失败
       
 >* 注意事项：<br />
    1. 设备端在有超时判断，15s内无一个正确可解析的数据维持ota的进行，由设备端发送*文件传输控制命令（控制动作：取消）*。<br />
    2. 设备端在接收到控制动作暂停，在指定延时时间内无收到*文件传输控制命令（控制动作：继续）*，由设备端发送*文件传输控制命令（控制动作：取消）*。<br />
    3. 设备端只允许一个app触发ota升级。当一个app在使用ota升级时，其他app通知ota升级计划都会被设备端拒绝。<br />
